<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ramadhan Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        button { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        input, button, select { font-size: 16px; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .floating { animation: float 3s ease-in-out infinite; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        const { useState, useEffect, useCallback } = React;
        
        const STORAGE_KEY = 'ramadhan-tracker-v2';
        
        // Default config - families can customize everything
        const defaultConfig = {
            year: 2026,
            startDate: '2026-02-19', // 1 Ramadhan
            endDate: '2026-03-20',   // 30 Ramadhan
            currency: 'RM',
            participants: [
                { id: 1, name: 'Ahmad', age: 10, color: '#4169E1', 
                  rules: { fullAmount: 2, fullLabel: 'Penuh (Maghrib)', 
                           halfAmount: 1, halfLabel: 'Asar', 
                           hasHalf: true } },
                { id: 2, name: 'Aisyah', age: 8, color: '#FF69B4', 
                  rules: { fullAmount: 2, fullLabel: 'Penuh (Maghrib)', 
                           halfAmount: 1, halfLabel: 'Asar', 
                           hasHalf: true } },
                { id: 3, name: 'Fatimah', age: 5, color: '#FFD700', 
                  rules: { fullAmount: 1, fullLabel: 'Zohor', 
                           halfAmount: 0, halfLabel: '', 
                           hasHalf: false } }
            ],
            history: {}
        };

        const colors = ['#4169E1', '#FF69B4', '#FFD700', '#22c55e', '#a855f7', '#f97316', '#06b6d4', '#ef4444'];

        const storage = {
            available: (() => { try { localStorage.setItem('t', '1'); localStorage.removeItem('t'); return true; } catch(e) { return false; } })(),
            get: (k) => { try { return localStorage.getItem(k); } catch(e) { return null; } },
            set: (k, v) => { try { localStorage.setItem(k, v); } catch(e) {} }
        };

        function formatDate(d) {
            const date = new Date(d);
            return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
        }

        function getToday() { return formatDate(new Date()); }

        function getDayNumber(dateStr, startDate) {
            const d1 = new Date(startDate);
            const d2 = new Date(dateStr);
            const diff = Math.floor((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;
            return diff >= 1 && diff <= 30 ? diff : null;
        }

        function calculateEarnings(participant, history) {
            const pid = participant.id;
            const records = Object.values(history).filter(h => h.participantId === pid);
            const full = records.filter(r => r.type === 'full').length;
            const half = records.filter(r => r.type === 'half').length;
            return (full * participant.rules.fullAmount) + (half * participant.rules.halfAmount);
        }

        function RamadhanTracker() {
            const [config, setConfig] = useState(null);
            const [history, setHistory] = useState({});
            const [selectedDate, setSelectedDate] = useState(getToday());
            const [view, setView] = useState('tracker'); // tracker, history, settings, summary
            const [loading, setLoading] = useState(true);
            const [editingParticipant, setEditingParticipant] = useState(null);

            useEffect(() => {
                const saved = storage.get(STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        setConfig({ ...defaultConfig, ...parsed.config });
                        setHistory(parsed.history || {});
                    } catch(e) {
                        setConfig(defaultConfig);
                        setHistory({});
                    }
                } else {
                    setConfig(defaultConfig);
                    setHistory({});
                }
                setLoading(false);
            }, []);

            const save = useCallback((newConfig, newHistory) => {
                const cfg = newConfig || config;
                const hist = newHistory || history;
                storage.set(STORAGE_KEY, JSON.stringify({ config: cfg, history: hist }));
            }, [config, history]);

            const recordFast = (participantId, type) => {
                const key = `${selectedDate}_${participantId}`;
                const newHistory = { ...history };
                
                if (type === 'none') {
                    delete newHistory[key];
                } else {
                    newHistory[key] = { date: selectedDate, participantId, type };
                }
                
                setHistory(newHistory);
                save(null, newHistory);
            };

            const getRecord = (participantId) => {
                return history[`${selectedDate}_${participantId}`]?.type || 'none';
            };

            const addParticipant = () => {
                const newId = Math.max(...config.participants.map(p => p.id), 0) + 1;
                const newParticipant = {
                    id: newId,
                    name: `Anak ${newId}`,
                    age: 7,
                    color: colors[newId % colors.length],
                    rules: { fullAmount: 2, fullLabel: 'Penuh', halfAmount: 1, halfLabel: 'Asar', hasHalf: true }
                };
                const newConfig = { ...config, participants: [...config.participants, newParticipant] };
                setConfig(newConfig);
                save(newConfig, null);
                setEditingParticipant(newParticipant);
            };

            const updateParticipant = (id, updates) => {
                const newParticipants = config.participants.map(p => p.id === id ? { ...p, ...updates } : p);
                const newConfig = { ...config, participants: newParticipants };
                setConfig(newConfig);
                save(newConfig, null);
            };

            const removeParticipant = (id) => {
                if (!confirm(`Buang ${config.participants.find(p => p.id === id)?.name}?`)) return;
                const newParticipants = config.participants.filter(p => p.id !== id);
                const newHistory = Object.fromEntries(Object.entries(history).filter(([k, v]) => v.participantId !== id));
                const newConfig = { ...config, participants: newParticipants };
                setConfig(newConfig);
                setHistory(newHistory);
                save(newConfig, newHistory);
            };

            const updateConfig = (updates) => {
                const newConfig = { ...config, ...updates };
                setConfig(newConfig);
                save(newConfig, null);
            };

            const resetAll = () => {
                if (!confirm('Reset SEMUA data? Ini akan hapus semua rekod dan tetapan!')) return;
                setConfig(defaultConfig);
                setHistory({});
                save(defaultConfig, {});
            };

            const exportData = () => {
                const data = JSON.stringify({ config, history, exported: new Date().toISOString() }, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ramadhan-tracker-${config.year}.json`;
                a.click();
            };

            const importData = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.config) {
                            setConfig(data.config);
                            setHistory(data.history || {});
                            save(data.config, data.history || {});
                            alert('Data imported successfully!');
                        }
                    } catch(err) {
                        alert('Invalid file format');
                    }
                };
                reader.readAsText(file);
            };

            if (loading || !config) return React.createElement('div', { className: 'min-h-screen flex items-center justify-center bg-gradient-to-br from-emerald-800 to-emerald-600' }, 
                React.createElement('div', { className: 'text-white text-2xl font-bold' }, 'ðŸŒ™ Loading...')
            );

            const dayNum = getDayNumber(selectedDate, config.startDate);
            const isRamadhan = dayNum !== null;

            // Views
            const renderTracker = () => {
                return React.createElement('div', { className: 'space-y-4' }, 
                    config.participants.map(p => {
                        const record = getRecord(p.id);
                        const earnings = calculateEarnings(p, history);
                        const totalDays = Object.values(history).filter(h => h.participantId === p.id && h.type !== 'none').length;
                        const progress = Math.min((totalDays / 30) * 100, 100);
                        
                        return React.createElement('div', {
                            key: p.id,
                            className: 'bg-white rounded-2xl shadow-xl overflow-hidden',
                            style: { border: `4px solid ${p.color}` }
                        }, [
                            React.createElement('div', { key: 'header', className: 'p-4', style: { background: `${p.color}15` } }, [
                                React.createElement('div', { key: 'top', className: 'flex items-center justify-between mb-3' }, [
                                    React.createElement('div', { key: 'name', className: 'flex items-center gap-3' }, [
                                        React.createElement('div', {
                                            className: 'w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-xl',
                                            style: { background: p.color }
                                        }, p.name.charAt(0)),
                                        React.createElement('div', {}, [
                                            React.createElement('h3', { className: 'font-black text-xl', style: { color: p.color } }, p.name),
                                            React.createElement('p', { className: 'text-xs text-gray-500' }, `${p.age} tahun â€¢ ${totalDays} hari`)
                                        ])
                                    ]),
                                    React.createElement('div', { key: 'money', className: 'text-right' }, [
                                        React.createElement('div', { className: 'text-3xl font-black text-green-600' }, `${config.currency}${earnings}`),
                                        React.createElement('div', { className: 'text-xs text-gray-500 font-bold' }, 'JUMLAH')
                                    ])
                                ]),
                                
                                React.createElement('div', { key: 'progress', className: 'w-full bg-gray-200 rounded-full h-3 mb-3' },
                                    React.createElement('div', {
                                        className: 'h-full rounded-full transition-all',
                                        style: { width: `${progress}%`, background: p.color }
                                    })
                                )
                            ]),
                            
                            React.createElement('div', { key: 'buttons', className: 'p-4 bg-gray-50 border-t-2 border-gray-200' }, [
                                React.createElement('p', { key: 'label', className: 'text-sm font-bold text-gray-600 mb-2 text-center' },
                                    `${formatDateDisplay(selectedDate)} ${dayNum ? `(Hari ${dayNum})` : ''}`
                                ),
                                React.createElement('div', { key: 'row', className: 'flex gap-2' }, [
                                    React.createElement('button', {
                                        onClick: () => recordFast(p.id, 'none'),
                                        className: `flex-1 py-3 rounded-xl font-bold ${record === 'none' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-600'}`
                                    }, 'âŒ Tak Puasa'),
                                    
                                    React.createElement('button', {
                                        onClick: () => recordFast(p.id, 'full'),
                                        className: `flex-1 py-3 rounded-xl font-bold ${record === 'full' ? 'bg-green-500 text-white' : 'bg-green-100 text-green-700'}`
                                    }, `${p.rules.fullLabel} (${config.currency}${p.rules.fullAmount})`),
                                    
                                    p.rules.hasHalf ? React.createElement('button', {
                                        onClick: () => recordFast(p.id, 'half'),
                                        className: `flex-1 py-3 rounded-xl font-bold ${record === 'half' ? 'bg-yellow-500 text-white' : 'bg-yellow-100 text-yellow-700'}`
                                    }, `${p.rules.halfLabel} (${config.currency}${p.rules.halfAmount})`) : null
                                ])
                            ])
                        ]);
                    })
                );
            };

            const renderSettings = () => {
                if (editingParticipant) {
                    const p = editingParticipant;
                    return React.createElement('div', { className: 'bg-white rounded-2xl p-6 shadow-xl space-y-4' }, [
                        React.createElement('h2', { key: 'title', className: 'text-2xl font-black text-emerald-800' }, `Edit: ${p.name}`),
                        
                        React.createElement('div', { key: 'name', className: 'space-y-2' }, [
                            React.createElement('label', { className: 'font-bold text-gray-700' }, 'Nama'),
                            React.createElement('input', {
                                type: 'text',
                                value: p.name,
                                onChange: (e) => setEditingParticipant({ ...p, name: e.target.value }),
                                className: 'w-full p-3 border-2 rounded-lg'
                            })
                        ]),
                        
                        React.createElement('div', { key: 'age', className: 'space-y-2' }, [
                            React.createElement('label', { className: 'font-bold text-gray-700' }, 'Umur'),
                            React.createElement('input', {
                                type: 'number',
                                value: p.age,
                                onChange: (e) => setEditingParticipant({ ...p, age: parseInt(e.target.value) || 0 }),
                                className: 'w-full p-3 border-2 rounded-lg'
                            })
                        ]),
                        
                        React.createElement('div', { key: 'color', className: 'space-y-2' }, [
                            React.createElement('label', { className: 'font-bold text-gray-700' }, 'Warna'),
                            React.createElement('input', {
                                type: 'color',
                                value: p.color,
                                onChange: (e) => setEditingParticipant({ ...p, color: e.target.value }),
                                className: 'w-full h-12 rounded-lg'
                            })
                        ]),
                        
                        React.createElement('div', { key: 'rules', className: 'space-y-3 border-t-2 pt-4' }, [
                            React.createElement('h3', { className: 'font-bold text-emerald-700' }, 'Peraturan Ganjaran'),
                            
                            React.createElement('div', { className: 'space-y-2' }, [
                                React.createElement('label', { className: 'text-sm font-bold text-gray-600' }, 'Label Penuh'),
                                React.createElement('input', {
                                    type: 'text',
                                    value: p.rules.fullLabel,
                                    onChange: (e) => setEditingParticipant({ ...p, rules: { ...p.rules, fullLabel: e.target.value } }),
                                    className: 'w-full p-2 border rounded'
                                })
                            ]),
                            
                            React.createElement('div', { className: 'space-y-2' }, [
                                React.createElement('label', { className: 'text-sm font-bold text-gray-600' }, `Ganjaran Penuh (${config.currency})`),
                                React.createElement('input', {
                                    type: 'number',
                                    value: p.rules.fullAmount,
                                    onChange: (e) => setEditingParticipant({ ...p, rules: { ...p.rules, fullAmount: parseFloat(e.target.value) || 0 } }),
                                    className: 'w-full p-2 border rounded'
                                })
                            ]),
                            
                            React.createElement('div', { className: 'flex items-center gap-2' }, [
                                React.createElement('input', {
                                    type: 'checkbox',
                                    checked: p.rules.hasHalf,
                                    onChange: (e) => setEditingParticipant({ ...p, rules: { ...p.rules, hasHalf: e.target.checked } }),
                                    id: 'hasHalf'
                                }),
                                React.createElement('label', { htmlFor: 'hasHalf', className: 'font-bold text-gray-700' }, 'Ada ganjaran separuh?')
                            ]),
                            
                            p.rules.hasHalf ? React.createElement('div', { className: 'space-y-2 pl-6' }, [
                                React.createElement('input', {
                                    type: 'text',
                                    value: p.rules.halfLabel,
                                    onChange: (e) => setEditingParticipant({ ...p, rules: { ...p.rules, halfLabel: e.target.value } }),
                                    className: 'w-full p-2 border rounded',
                                    placeholder: 'Label (contoh: Asar)'
                                }),
                                React.createElement('input', {
                                    type: 'number',
                                    value: p.rules.halfAmount,
                                    onChange: (e) => setEditingParticipant({ ...p, rules: { ...p.rules, halfAmount: parseFloat(e.target.value) || 0 } }),
                            
